#!/bin/bash
#
# Copyright (c) 2016 Regents of The University of Michigan.
# All Rights Reserved.
#
# Author: Robert <heinro@med.umich.edu>
#

usage() {
    if [ "$VERBOSITY" -ge 1 ]; then
	echo "
USAGE: $SCRIPT_NAME [-h|--help|--no-color|-v|verbosity n]
"
    fi
}

user_help() {
    echo "$SCRIPT_NAME - Assemble one Sample's fastq data"
    usage
    echo "Command line parameters:
    --working-dir <path>  Where to retrieve and store files
    --cpus <n>
    --clean-only
-h  --help          Print this help.
    --no-color      Disable colorful output.
-v                  Verbosity: use multiple -v to increase output.
    --verbosity <n> Set level verbosity.
"
}

exception () {
    echo "[${RED}ERROR${ENDCOLOR}] at line $1; error code $2"
}

debug() {
    [ "$VERBOSITY" -ge 3 ] && echo "[$SCRIPT_NAME] [DEBUG] $1"
}

info() {
    [ "$VERBOSITY" -ge 1 ] && echo "[$SCRIPT_NAME] $1"
}

warning() {
    [ "$VERBOSITY" -ge 1 ] && echo -e "[$SCRIPT_NAME] [${ORANGE}WARNING${ENDCOLOR}] $1"
}

error() {
    [ "$VERBOSITY" -ge -1 ] && >&2 echo -e "[$SCRIPT_NAME] [${RED}ERROR${ENDCOLOR}] $1"
}

abort() {
    # write an error message and exit.  If the last positional parameter is 'usage' then also print the usage text.
    >&2 echo -e "[$SCRIPT_NAME] [${RED}ABORT${ENDCOLOR}] $1"
    if [ "$VERBOSITY" -ge 0 ]; then
	if [ $# -ge 0 ]; then
	    [ "${!#}" == "usage" ] && usage
	fi
    fi
    exit 1
}


# get name of this script
SCRIPT_NAME=$(basename "$0")

##########################
# default variable values
##########################

# Required Databases
PATH2SILVA="/omics/PublicDB/silva/release_123/SILVA_123_SSURef_tax_silva.fasta"
PATH2BACT="/omics/PublicDB/NCBI/Bacteria/latest_16S.fasta"
PATH2ARCH="/omics/PublicDB/NCBI/Archaea/latest_16S.fasta"
PATH2MARKERS="${HOME}/share/phylosift"
PATH2SCRIPTS="/geomicro/data1/COMMON/scripts"
# IDBA Parameters
MINK=52
MAXK=92
STEP=8

# other scripts
QUAST="/usr/bin/python $(which quast.py)"
TOP5="perl $PATH2SCRIPTS/BlastTools/top5.pl"
EXTRACT_SUB_SEQ="perl $PATH2SCRIPTS/SeqTools/extractSubSeq.pl"
#
CLEAN_ONLY=false
#
CPUS=4
#
WORK_DIR=$(pwd)
# default verbosity level
VERBOSITY=1
# Enable colorful output by default
USE_COLOR=true

###################################3
# command line parameter handling
###################################
GETOPT_SHORT=hv
GETOPT_LONG=clean-only,cpus:,help,no-color,working-dir:,verbosity:
if which getopt >/dev/null 2>&1; then
    getopt -T
    if [ "$?" == 4 ]; then
        # GNU getopt available 
        _getopt=$(getopt -o "$GETOPT_SHORT" --long "$GETOPT_LONG" --name "$SCRIPT_NAME" -- "$@")
        if [ "$?" != 0 ]; then usage; exit 1; fi
    else
	# for non-GNU getopt (on MacOSX?)
	# try best effort without handling long options
	# TODO: this path needs testing
        _getopt=$(getopt -o "$GETOPT_SHORT" --name "$SCRIPT_NAME" -- "$@")
        if [ "$?" != 0 ]; then usage; exit 1; fi
    fi
    # reset $n parameters
    eval set -- "$_getopt"
fi

# handle options arguments / should work with/without getopt
while [ "$#" -gt 0 ]; do
    case "$1" in
	(--clean-only)
	    CLEAN_ONLY=true
	    ;;
	(--cpus)
	    CPUS="$2"
	    shift
	    ;;
	(--working-dir)
	    WORK_DIR="$2"
            shift
	    ;;
	(-h|--help) user_help; exit 0;;
	(--no-color) USE_COLOR=false;;
	(-v) VERBOSITY=$((VERBOSITY+1));;
	(--verbosity)
	    VERBOSITY="$2"
	    [[ "$VERBOSITY" =~ ^[[:digit:]]+$ ]] || abort "Verbosity level must be a positive integer." usage 
	    shift
	    ;;
	(--) shift; break;;
	(-|-*) abort "invalid command line option: $1" usage;;
	(*) break;; # getopt failure? assume this and following are non-option args
    esac
    shift
done

##########################################################
# color output
#
# for color codes see:
# https://en.wikipedia.org/wiki/ANSI_escape_code#Colors
#
# 
if [ "$USE_COLOR" == true ]; then
    if which tput >/dev/null 2>&1 && [ "$(tput colors)" -ge 8 ]; then
	RED=$(tput setaf 1)
	ORANGE=$(tput bold)$(tput setaf 1)
	ENDCOLOR=$(tput sgr0)
    fi
fi

debug "command line options: $_getopt"
debug "verbosity set to: $VERBOSITY"
# set bash script debugging
[ "$VERBOSITY" -ge 4 ] && set -x
# forward verbosity to other commands
[ "$VERBOSITY" -ge 2 ] && VERBOSE_FLAG=-v
V=$VERBOSE_FLAG

# handle non-option parameters
if [ "$#" -gt 0 ]; then
    abort "Unknown parameters: ${*}"
fi

#########################
# some input sanitation
#########################
[ -d "$WORK_DIR" ] || abort "$WORK_DIR is not accessible."

####################################
# check presence of necessary tools
####################################
for i in idba_ud quast.py; do
    which $i > /dev/null 2>&1 || abort "$i command is not available."
done

###############################
# enable error trapping
###############################
set -e
trap 'exception $LINENO $?' ERR



#################################
# do stuff
################################
spec=k${MINK}_${MAXK}_s${STEP}
scaf=ASSEMBLY/$spec/scaffold.fa

cd "$WORK_DIR"

rm $V -rf ASSEMBLY
if $CLEAN_ONLY; then
    exit 0
fi

mkdir $V -p ASSEMBLY
mkdir $V -p ASSEMBLY/BLASTN
mkdir $V -p ASSEMBLY/PhyloSift
cd ASSEMBLY

info "Assembling..."
idba_ud -o $spec -r ../dt_int.fasta --num_threads "$CPUS" --mink $MINK --maxk $MAXK --step $STEP &> $spec.log

info "Making assembly stats..."
$QUAST -f --meta -T "$CPUS" -l "Scaffolds, Contigs" $scaf $spec/contig.fa &> quast.log

info "Searching for scaffolds with 16S..."
T1BLAST=BLASTN/sample_vs_silvaSSU119.topHits.blastn
BBLAST=BLASTN/sample_subSeq_vs_bactNCBI.blastn
ABLAST=BLASTN/sample_subSeq_vs_archaeaNCBI.blastn
SSEQ=BLASTN/silvaSSU119.topHits.fasta
mkdir -p BLASTN
blastn -query $scaf -db $PATH2SILVA -outfmt "7 std qlen stitle" -out $T1BLAST -num_threads "$CPUS"
if [ ! -s BLASTN/sample_vs_silvaSSU119.blastn ]; then
    info "Looking up top hits from 16S search for complete genomes in NCBI..."
    $TOP5 -t 1 -b BLASTN/sample_vs_silva.blastn -o $T1BLAST
    $EXTRACT_SUB_SEQ -query -blast $T1BLAST -f $scaf -o $SSEQ
    blastn -query $SSEQ -db $PATH2BACT -outfmt "7 std qlen qcovs stitle" -out $BBLAST -num_threads "$CPUS"
    blastn -query $SSEQ -db $PATH2ARCH -outfmt "7 std qlen qcovs stitle" -out $ABLAST -num_threads "$CPUS"
    $TOP5 -t 1 -b $BBLAST -o ${BBLAST/%blastn/top_hits.blastn}
    $TOP5 -t 1 -b $ABLAST -o ${ABLAST/%blastn/top_hits.blastn}
fi

info "Running PyloSift..."
if [ -d "$PATH2MARKERS" ]; then
    phylosift all --disable_updates --output PhyloSift/Whole_Assembly $scaf
else
    warning "--- running PyloSift in update mode ---"
    phylosift all --output PhyloSift/Whole_Assembly $scaf
fi

ln "$scaf" "$WORK_DIR"/scaffold.fa

info "[assembly done]"
# gmb: input: dt_int.fasta
# gmb: output: scaffold.fa
# gmb: args: --cpus {{ cpus }} --no-color
# gmb: cpus_min: 1
# gmb: cpus_max: CPUS
